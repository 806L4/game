<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Elite 806L4 Online</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase -->
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        :root { --pink: #ff4b6e; --dark: #0f172a; --gold: #ffd700; }
        body { margin: 0; background: var(--dark); color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .hud { position: absolute; top: 15px; left: 15px; z-index: 10; font-family: monospace; font-size: 18px; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px; }
        .overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(10px); }
        .menu { background: #1e293b; padding: 30px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; border: 2px solid var(--pink); }
        
        /* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
        #topList { text-align: left; margin: 15px 0; max-height: 150px; overflow-y: auto; font-size: 14px; border-top: 1px solid #334155; padding-top: 10px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 5px; color: #94a3b8; }
        .row.me { color: var(--gold); font-weight: bold; }

        input { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; width: 100%; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; text-align: center; }
        button { background: var(--pink); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .ship-select { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
        .ship-btn { background: #334155; padding: 8px; border-radius: 5px; font-size: 10px; cursor: pointer; border: 1px solid transparent; }
        .ship-btn.active { border-color: var(--pink); background: #475569; }
    </style>
</head>
<body>

<div class="hud">üí∞ <span id="hCoins">0</span> | ‚≠ê <span id="hScore">0</span></div>

<div id="mainMenu" class="overlay">
    <div class="menu">
        <h2 style="margin-top:0">AVIATOR ONLINE</h2>
        <input type="text" id="pName" placeholder="–¢–≤–æ–π –ø–æ–∑—ã–≤–Ω–æ–π" maxlength="10">
        
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">–í–´–ë–ï–†–ò –°–ê–ú–û–õ–ï–¢:</div>
        <div class="ship-select" id="sGrid"></div>

        <div style="font-size: 12px; color: var(--pink); margin-bottom: 5px;">–û–ù–õ–ê–ô–ù –†–ï–ö–û–†–î–´:</div>
        <div id="topList">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞...</div>

        <button onclick="game.start()">–í–ó–õ–ï–¢ üöÄ</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
// --- 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE ---
const SB_URL = 'https://mnfddistqwbtmcyroojg.supabase.co'; 
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZmRkaXN0cXdidG1jeXJvb2pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MDYzMjYsImV4cCI6MjA4Njk4MjMyNn0.8TMxgNPykwOCIVGfLLKv2aFnVukt4UueHuLDOs3qt3w';
const sb = supabase.createClient(SB_URL, SB_KEY);

// --- 2. –î–ê–ù–ù–´–ï –ò–ì–†–´ ---
const ships = [
    { n: "–Ø–∫-52", d: "–£—á–µ–±–Ω—ã–π –≤–∏–Ω—Ç.", p: 0, c: "#ff4b6e" },
    { n: "L-39", d: "–†–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä.", p: 500, c: "#00d2ff" },
    { n: "–ú–∏–ì-15", d: "–õ–µ–≥–µ–Ω–¥–∞ –≤–æ–π–Ω—ã.", p: 1500, c: "#94a3b8" },
    { n: "F-86 Sabre", d: "–ö–ª–∞—Å—Å–∏–∫–∞ –°–®–ê.", p: 3000, c: "#ffd700" },
    { n: "–ú–∏–ì-21", d: "–°–≤–µ—Ä—Ö–∑–≤—É–∫.", p: 7000, c: "#9c27b0" },
    { n: "F-4 Phantom", d: "–¢—è–∂–µ–ª—ã–π –∑–≤–µ—Ä—å.", p: 12000, c: "#795548" },
    { n: "–ú–∏–ì-25", d: "–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫.", p: 20000, c: "#607d8b" },
    { n: "F-14 Tomcat", d: "–ü–∞–ª—É–±–Ω—ã–π –∞—Å.", p: 30000, c: "#3f51b5" },
    { n: "–°—É-27", d: "–ú–∞–Ω–µ–≤—Ä–µ–Ω–Ω–æ—Å—Ç—å.", p: 45000, c: "#03a9f4" },
    { n: "F-15 Eagle", d: "–ù–µ–ø–æ–±–µ–¥–∏–º—ã–π.", p: 60000, c: "#8bc34a" },
    { n: "–ú–∏–ì-31", d: "–ö–æ—Ä–æ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏.", p: 75000, c: "#ff9800" },
    { n: "F-22 Raptor", d: "–°—Ç–µ–ª—Å.", p: 95000, c: "#212121" },
    { n: "–°—É-57", d: "5-–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ.", p: 120000, c: "#455a64" },
    { n: "SR-71", d: "–°—Ç—Ä–∞—Ç–æ—Å—Ñ–µ—Ä–∞.", p: 160000, c: "#1a1a1a" },
    { n: "Starship", d: "–ö–æ—Å–º–æ—Å.", p: 250000, c: "gold" }
];

const ranks = [{m:0, t:"–ö–£–†–°–ê–ù–¢"}, {m:5000, t:"–ü–ò–õ–û–¢"}, {m:20000, t:"–ê–°"}, {m:100000, t:"–ú–ê–†–®–ê–õ"}];

// --- 3. –ó–í–£–ö–û–í–û–ô –î–í–ò–ñ–û–ö ---
const audio = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play(f, t, d, v) {
        if (this.ctx.state === 'suspended') this.ctx.resume();
        const o = this.ctx.createOscillator(), g = this.ctx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + d);
        g.gain.setValueAtTime(v, this.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, this.ctx.currentTime + d);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + d);
    },
    shoot() { this.play(400, 'square', 0.1, 0.05); },
    boom() { this.play(100, 'sawtooth', 0.4, 0.15); },
    click() { this.play(800, 'sine', 0.05, 0.1); }
};

// --- 4. –°–û–°–¢–û–Ø–ù–ò–ï –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
let db = JSON.parse(localStorage.getItem('avi_online_pro')) || { n: "–ü–∏–ª–æ—Ç", c: 0, u: [true], cur: 0, hi: 0 };
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let particles = [], powerups = [], bullets = [], enemies = [];
let combo = 1, comboTimer = 0, freezeTimer = 0, tripleTimer = 0;
let activePw = { shield: false, freeze: false, triple: false };
let boss = null, bossCounter = 1;

// --- 5. –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
const ui = {
    tab: (id, el) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        el.classList.add('active');
        if(id === 'leader') ui.loadTop();
    },
    render: () => {
        const g = document.getElementById('sGrid'); g.innerHTML = '';
        ships.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = `shop-item ${db.cur === i ? 'selected' : ''}`;
            d.innerHTML = `<b>${s.n}</b><br><small>${db.u[i] ? '–í–ó–õ–ï–¢' : s.p+'üí∞'}</small>`;
            d.onclick = () => {
                audio.click();
                if(db.u[i]) db.cur = i;
                else if(db.c >= s.p) { db.c -= s.p; db.u[i] = true; db.cur = i; }
                ui.save(); ui.render();
            };
            g.appendChild(d);
        });
        document.getElementById('hCoins').innerText = db.c;
        document.getElementById('rankBadge').innerText = "–ó–í–ê–ù–ò–ï: " + (ranks.slice().reverse().find(r => db.hi >= r.m)?.t || "–ö–£–†–°–ê–ù–¢");
    },
    save: () => localStorage.setItem('avi_online_pro', JSON.stringify(db)),
    loadTop: async () => {
        const { data } = await sb.from('leaderboard').select('*').order('score', { ascending: false }).limit(5);
        if(data) document.getElementById('lList').innerHTML = data.map((p, i) => `<div class="leader-row"><span>${i+1}. ${p.name}</span><b>${p.score}</b></div>`).join('');
    }
};

// --- 6. –ò–ì–†–û–í–û–ô –î–í–ò–ñ–û–ö ---
function createExplosion(x, y, color) {
    for (let i = 0; i < 15; i++) particles.push({ x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, size: Math.random()*4+2, color, alpha: 1 });
    audio.boom();
}

const game = {
    active: false, score: 0,
    p: { x: 0, y: 0, tx: 0, ty: 0 },
    start: () => {
        audio.click();
        db.n = document.getElementById('pName').value || db.n;
        ui.save();
        document.getElementById('mainMenu').style.display = 'none';
        game.active = true; game.score = 0; combo = 1; boss = null; bossCounter = 1;
        enemies = []; bullets = []; particles = []; powerups = [];
        activePw = { shield: false, freeze: false, triple: false };
        game.p.x = canvas.width/2; game.p.y = canvas.height-100;
        game.spawn(); game.loop();
    },
    spawn: () => {
        if(!game.active || boss) return;
        enemies.push({ x: Math.random()*canvas.width, y: -50, s: 3+Math.random()*3 });
        setTimeout(game.spawn, Math.max(250, 1000 - game.score/10));
    },
    loop: () => {
        if(!game.active) return;
        ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);

        // –¢–∞–π–º–µ—Ä—ã
        if(comboTimer > 0) comboTimer--; else combo = 1;
        if(freezeTimer > 0) freezeTimer--; else activePw.freeze = false;
        if(tripleTimer > 0) tripleTimer--; else activePw.triple = false;

        // –ë–æ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∞
        if(!boss && game.score >= bossCounter * 1000) {
            boss = { x: canvas.width/2, y: -100, hp: 50*bossCounter, maxHp: 50*bossCounter, dir: 1 };
        }

        // –ë–æ–Ω—É—Å—ã
        powerups.forEach((pw, i) => {
            pw.y += 2; ctx.fillStyle = pw.c; ctx.beginPath(); ctx.arc(pw.x, pw.y, 15, 0, Math.PI*2); ctx.fill();
            if(Math.hypot(pw.x-game.p.x, pw.y-game.p.y) < 35) {
                audio.play(600, 'sine', 0.2, 0.2);
                if(pw.type === 'shield') activePw.shield = true;
                if(pw.type === 'freeze') { activePw.freeze = true; freezeTimer = 300; }
                if(pw.type === 'triple') { activePw.triple = true; tripleTimer = 300; }
                powerups.splice(i, 1);
            }
        });

        // –ò–≥—Ä–æ–∫
        game.p.x += (game.p.tx - game.p.x) * 0.15;
        game.p.y += (game.p.ty - game.p.y) * 0.15;
        ctx.fillStyle = ships[db.cur].c;
        ctx.beginPath(); ctx.moveTo(game.p.x, game.p.y-20); ctx.lineTo(game.p.x+18, game.p.y+12); ctx.lineTo(game.p.x-18, game.p.y+12); ctx.fill();
        if(activePw.shield) { ctx.strokeStyle = '#00d2ff'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(game.p.x, game.p.y, 35, 0, Math.PI*2); ctx.stroke(); }
        if(combo > 1) { ctx.fillStyle = 'white'; ctx.fillText('x'+combo+' COMBO', game.p.x+25, game.p.y); }

        // –°—Ç—Ä–µ–ª—å–±–∞
        if(Date.now() % 140 < 20) {
            audio.shoot();
            const vx = activePw.triple ? [-3, 0, 3] : [0];
            vx.forEach(v => bullets.push({x: game.p.x, y: game.p.y-20, vx: v}));
        }
        bullets.forEach((b, i) => {
            b.y -= 12; b.x += (b.vx || 0);
            ctx.fillStyle = activePw.triple ? 'gold' : '#ff4b6e';
            ctx.fillRect(b.x-2, b.y, 4, 12);
            if(b.y < 0) bullets.splice(i, 1);
        });

        // –õ–æ–≥–∏–∫–∞ –ë–æ—Å—Å–∞
        if(boss) {
            boss.y += (80 - boss.y) * 0.02; boss.x += boss.dir * 2;
            if(boss.x > canvas.width-60 || boss.x < 60) boss.dir *= -1;
            ctx.fillStyle = '#ff4b6e'; ctx.fillRect(boss.x-50, boss.y-30, 100, 60);
            ctx.fillStyle = '#334155'; ctx.fillRect(canvas.width/2-100, 20, 200, 10);
            ctx.fillStyle = '#ff4b6e'; ctx.fillRect(canvas.width/2-100, 20, (boss.hp/boss.maxHp)*200, 10);
            if(Date.now() % 800 < 20) enemies.push({x: boss.x, y: boss.y+30, s: 5, bM: true});
            bullets.forEach((b, bi) => {
                if(Math.abs(b.x-boss.x)<50 && Math.abs(b.y-boss.y)<30) {
                    boss.hp--; bullets.splice(bi, 1); createExplosion(b.x, b.y, 'gold');
                    if(boss.hp <= 0) { game.score += 500; db.c += 50; boss = null; bossCounter++; audio.boom(); game.spawn(); }
                }
            });
            if(Math.hypot(boss.x-game.p.x, boss.y-game.p.y) < 60 && !activePw.shield) game.over();
        }

        // –í—Ä–∞–≥–∏
        enemies.forEach((en, i) => {
            en.y += activePw.freeze ? en.s*0.2 : en.s;
            ctx.fillStyle = en.bM ? '#ff4b6e' : (activePw.freeze ? '#00d2ff' : 'white');
            ctx.fillRect(en.x-15, en.y-15, 30, 30);
            bullets.forEach((b, bi) => {
                if(Math.hypot(en.x-b.x, en.y-b.y) < 25) {
                    createExplosion(en.x, en.y, '#ffd700');
                    if(Math.random()<0.15) {
                        const t = ['shield','freeze','triple'][Math.floor(Math.random()*3)];
                        powerups.push({x: en.x, y: en.y, type: t, c: t==='shield'?'#00d2ff':t==='freeze'?'#fff':'gold'});
                    }
                    enemies.splice(i, 1); bullets.splice(bi, 1); game.score += 10*combo; db.c++; combo++; comboTimer = 60;
                    document.getElementById('hScore').innerText = game.score; document.getElementById('hCoins').innerText = db.c;
                }
            });
            if(Math.hypot(en.x-game.p.x, en.y-game.p.y) < 35) {
                if(activePw.shield) { activePw.shield = false; createExplosion(en.x, en.y, '#00d2ff'); enemies.splice(i,1); }
                else game.over();
            }
            if(en.y > canvas.height) enemies.splice(i, 1);
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–∞—Å—Ç–∏—Ü
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.alpha -= 0.02;
            ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
            if(p.alpha <= 0) particles.splice(i, 1);
        });
        ctx.globalAlpha = 1;
        requestAnimationFrame(game.loop);
    },
    over: async () => {
        game.active = false;
        if(game.score > db.hi) { db.hi = game.score; await sb.from('leaderboard').upsert([{ name: db.n, score: db.hi }], { onConflict: 'name' }); }
        ui.save(); alert("–°–ê–ú–û–õ–ï–¢ –°–ë–ò–¢! –°—á–µ—Ç: " + game.score); location.reload();
    }
};

// --- –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
const up = (e) => { game.p.tx = e.touches ? e.touches.clientX : e.clientX; game.p.ty = e.touches ? e.touches.clientY : e.clientY; };
window.addEventListener('mousemove', up);
window.addEventListener('touchmove', (e) => { e.preventDefault(); up(e); }, {passive:false});
window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
window.dispatchEvent(new Event('resize'));
ui.render();
</script>
</body>
</html>
