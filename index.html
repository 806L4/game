<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram -->
    <script src="https://telegram.org"></script>
    
    <!-- PWA –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    
    <title>–ê–≤–∏–∞—Ç–æ—Ä –≠–ª–∏—Ç–∞</title>
    <style>
        :root { --pink: #ff4b6e; --gold: #ffd700; --blue: #00d2ff; }
        body { margin: 0; background: #0b0e14; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; }
        canvas { display: block; }
        
        /* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        #pwa-banner { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 400px; background: white; color: #333; 
            padding: 20px; border-radius: 20px; z-index: 1000; 
            display: none; text-align: center; border: 3px solid var(--pink);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .hud { position: absolute; top: 10px; left: 10px; z-index: 10; font-size: 14px; background: rgba(0,0,0,0.6); padding: 12px; border-radius: 12px; pointer-events: none; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); z-index: 100; }
        .menu-card { background: #1a1c23; padding: 25px; border-radius: 24px; text-align: center; border: 2px solid var(--pink); width: 85%; max-width: 380px; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; max-height: 220px; overflow-y: auto; }
        .shop-item { background: #252833; padding: 10px; border-radius: 15px; font-size: 11px; cursor: pointer; border: 2px solid transparent; }
        .shop-item.active { border-color: var(--pink); background: #351a24; }
        button { background: var(--pink); color: white; border: none; padding: 14px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .author { margin-top: 15px; font-size: 8px; color: rgba(255,255,255,0.3); letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="pwa-banner">
    <h3 id="pwa-title">–£—Å—Ç–∞–Ω–æ–≤–∏ –∏–≥—Ä—É! üì±</h3>
    <p id="pwa-text">–ù–∞–∂–º–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" -> "–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π" (–¥–ª—è iPhone) –∏–ª–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.</p>
    <button id="pwa-button">–£–°–¢–ê–ù–û–í–ò–¢–¨</button>
    <button onclick="this.parentElement.style.display='none'" style="background:#555; margin-top:5px; font-size:12px;">–ü–û–ó–ñ–ï</button>
</div>

<div class="hud">
    üí∞ <span id="coinsHUD">0</span> | ‚≠ê <span id="scoreHUD">0</span><br>
    ‚õΩ <progress id="fuelBar" value="100" max="100" style="width:80px;"></progress>
</div>

<div id="mainMenu" class="overlay">
    <div class="menu-card">
        <h2 style="margin:0; color:var(--pink);">–ê–ù–ì–ê–† –°–ê–ú–û–õ–ï–¢–û–í</h2>
        <p>–ë–∞–ª–∞–Ω—Å: <b id="totalCoins" style="color:var(--gold);">0</b> üí∞</p>
        <div class="shop-grid" id="shopGrid"></div>
        <div style="font-size: 11px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px;">
            üèÜ –¢–û–ü: <span id="bestScoresList">0</span>
        </div>
        <button onclick="startGame()">–í–ó–õ–ï–¢ üöÄ</button>
        <div class="author">MADE BY <b>806L4</b> WITH STRONG SUPPORT FROM AI</div>
    </div>
</div>

<canvas id="game"></canvas>

<script>
// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ---
const tg = window.Telegram?.WebApp;
if (tg) {
    tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –≤ –¢–ì
    tg.headerColor = '#0b0e14';
    tg.backgroundColor = '#0b0e14';
}

// --- –î–ï–¢–ï–ö–¢–û–† –£–°–¢–ê–ù–û–í–ö–ò (–Ø–Ω–¥–µ–∫—Å, Chrome, Safari) ---
let deferredPrompt;
const pwaBanner = document.getElementById('pwa-banner');
const pwaBtn = document.getElementById('pwa-button');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    pwaBanner.style.display = 'block';
    document.getElementById('pwa-title').innerText = "–ò–≥—Ä–∞–π –≤ –Ø–Ω–¥–µ–∫—Å–µ!";
    document.getElementById('pwa-text').innerText = "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª.";
});

pwaBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') pwaBanner.style.display = 'none';
        deferredPrompt = null;
    }
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è iPhone (Safari)
if (/iPhone|iPad/.test(navigator.userAgent) && !window.navigator.standalone) {
    pwaBanner.style.display = 'block';
    pwaBtn.style.display = 'none'; // –£ iPhone –Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–µ–Ω—é "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
}

// --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const shipModels = [
    { name: "–ö—É–∫—É—Ä—É–∑–Ω–∏–∫", speed: 5, hp: 1, guns: 1, price: 0, color: '#ff4b6e', icon: 'üõ©Ô∏è' },
    { name: "–ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å", speed: 8, hp: 1, guns: 1, price: 300, color: '#00d2ff', icon: '‚úàÔ∏è' },
    { name: "–ë–æ–º–±–µ—Ä", speed: 4, hp: 3, guns: 1, price: 800, color: '#4caf50', icon: 'üöÄ' },
    { name: "–®—Ç—É—Ä–º–æ–≤–∏–∫", speed: 7, hp: 2, guns: 2, price: 1500, color: '#ffd700', icon: 'üöÅ' },
    { name: "–§–∞–Ω—Ç–æ–º-X", speed: 10, hp: 2, guns: 3, price: 3000, color: '#9c27b0', icon: 'üõ∏' }
];

let userData = JSON.parse(localStorage.getItem('aviator_806L4_final')) || {
    coins: 0, bestScores: [], unlockedShips: [true, false, false, false, false], currentShipIndex: 0
};

let score = 0, fuel = 100, gameActive = false, freezeTimer = 0;
let player = { x: canvas.width/2-20, y: canvas.height-100, w: 40, h: 40, shield: 0 };
const enemies = [], bullets = [], items = [];

function updateUI() {
    document.getElementById('totalCoins').innerText = userData.coins;
    document.getElementById('coinsHUD').innerText = userData.coins;
    document.getElementById('bestScoresList').innerText = userData.bestScores.slice(0,3).join(', ') || '0';
    const grid = document.getElementById('shopGrid');
    grid.innerHTML = '';
    shipModels.forEach((s, i) => {
        const isUnlocked = userData.unlockedShips[i];
        const div = document.createElement('div');
        div.className = `shop-item ${isUnlocked ? '' : 'locked'} ${userData.currentShipIndex === i ? 'active' : ''}`;
        div.innerHTML = `<span style="font-size:20px">${s.icon}</span><br><b>${s.name}</b><br><span style="color:var(--gold)">${isUnlocked ? '–í–´–ë–†–ê–¢–¨' : s.price+'üí∞'}</span>`;
        div.onclick = () => {
            if (isUnlocked) userData.currentShipIndex = i;
            else if (userData.coins >= s.price) { userData.coins -= s.price; userData.unlockedShips[i] = true; userData.currentShipIndex = i; tg?.HapticFeedback.notificationOccurred('success'); }
            save(); updateUI();
        };
        grid.appendChild(div);
    });
}

function save() { localStorage.setItem('aviator_806L4_final', JSON.stringify(userData)); }

function drawPlane(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x + 15, y, 10, 40); 
    ctx.fillRect(x, y + 15, 40, 8);  
    ctx.fillRect(x + 10, y + 35, 20, 5);
}

function shoot() {
    if(!gameActive) return;
    const ship = shipModels[userData.currentShipIndex];
    if(ship.guns === 1) bullets.push({x: player.x+18, y: player.y, w:4, h:10});
    if(ship.guns === 2) { bullets.push({x: player.x+5, y: player.y+10, w:4, h:10}); bullets.push({x: player.x+31, y: player.y+10, w:4, h:10}); }
    if(ship.guns === 3) { bullets.push({x: player.x+18, y: player.y, w:4, h:10}); bullets.push({x: player.x, y: player.y+15, w:4, h:10, vx:-2}); bullets.push({x: player.x+36, y: player.y+15, w:4, h:10, vx:2}); }
}

function loop() {
    if(!gameActive) return;
    ctx.fillStyle = "#0b0e14"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    if(freezeTimer > 0) freezeTimer--;

    drawPlane(player.x, player.y, shipModels[userData.currentShipIndex].color);
    if(player.shield > 0) { ctx.strokeStyle = var(--blue); ctx.lineWidth=2; ctx.beginPath(); ctx.arc(player.x+20, player.y+20, 30, 0, Math.PI*2); ctx.stroke(); }

    if(Math.random() < 0.03 && freezeTimer === 0) enemies.push({x: Math.random()*(canvas.width-40), y: -50, w: 40, h: 40});
    enemies.forEach((en, i) => {
        if(freezeTimer === 0) en.y += (4 + score/1000);
        drawPlane(en.x, en.y, "#333");
        if(intersect(player, en)) { 
            if(player.shield > 0) { player.shield--; enemies.splice(i,1); tg?.HapticFeedback.impactOccurred('medium'); } 
            else endGame(); 
        }
        bullets.forEach((b, bi) => { 
            if(intersect(b, en)) { userData.coins += 5; enemies.splice(i,1); bullets.splice(bi,1); score += 10; tg?.HapticFeedback.impactOccurred('light'); } 
        });
        if(en.y > canvas.height) enemies.splice(i, 1);
    });

    bullets.forEach((b, i) => { b.y -= 10; if(b.vx) b.x += b.vx; ctx.fillStyle = "yellow"; ctx.fillRect(b.x, b.y, b.w, b.h); if(b.y < 0) bullets.splice(i,1); });

    if(Math.random() < 0.01) items.push({x: Math.random()*(canvas.width-30), y: -50, w: 30, h: 30, t: ['f','c','s','z'][Math.floor(Math.random()*4)]});
    items.forEach((it, i) => {
        it.y += 3;
        ctx.font = "20px serif"; ctx.fillText(it.t==='f'?'‚õΩ':it.t==='c'?'üí∞':it.t==='s'?'üõ°Ô∏è':'‚ùÑÔ∏è', it.x, it.y);
        if(intersect(player, it)) {
            if(it.t==='f') fuel = Math.min(100, fuel + 30);
            if(it.t==='c') userData.coins += 50;
            if(it.t==='s') player.shield++;
            if(it.t==='z') freezeTimer = 180;
            items.splice(i, 1);
            tg?.HapticFeedback.notificationOccurred('success');
        }
    });

    fuel -= 0.08;
    document.getElementById('scoreHUD').innerText = score;
    document.getElementById('coinsHUD').innerText = userData.coins;
    document.getElementById('fuelBar').value = fuel;
    if(fuel <= 0) endGame();
    requestAnimationFrame(loop);
}

function move(e) { 
    if(!gameActive) return; 
    let x = e.clientX || (e.touches && e.touches[0].clientX); 
    let y = e.clientY || (e.touches && e.touches[0].clientY); 
    player.x = x - 20; player.y = y - 20; 
}
window.addEventListener('mousemove', move);
window.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, {passive: false});
window.addEventListener('mousedown', shoot);

function intersect(r1, r2) { return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y); }
function startGame() { gameActive = true; score = 0; fuel = 100; freezeTimer = 0; enemies.length = 0; bullets.length = 0; items.length = 0; player.shield = shipModels[userData.currentShipIndex].hp - 1; document.getElementById('mainMenu').style.display = 'none'; loop(); }
function endGame() { gameActive = false; userData.bestScores.push(score); userData.bestScores.sort((a,b)=>b-a); save(); updateUI(); document.getElementById('mainMenu').style.display = 'flex'; tg?.HapticFeedback.notificationOccurred('error'); }

if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
updateUI();
</script>
</body>
</html>
